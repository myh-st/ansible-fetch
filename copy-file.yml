---
  - hosts: all
    # become: yes
    # become_user: testuser
    gather_facts: no
    tasks:
      - name: fetch /etc/hosts
        fetch:
          src: /etc/hosts
          dest: result/{{ inventory_hostname }}/
          flat: true

      - name: fetch /etc/resolv.conf
        fetch:
          src: /etc/resolv.conf
          dest: result/{{ inventory_hostname }}/
          flat: true

      - name: remove localhost in hosts file
        lineinfile:
          path: result/{{ inventory_hostname }}/hosts
          state: absent
          regexp: '^127\.0\.0\.1'
        delegate_to: localhost

      - name: remove ::1 in hosts file
        lineinfile:
          path: result/{{ inventory_hostname }}/hosts
          state: absent
          regexp: '^::1'
        delegate_to: localhost

      - name: remove comment in hosts file
        lineinfile:
          path: result/{{ inventory_hostname }}/hosts
          state: absent
          regexp: '^#'
        delegate_to: localhost

      - name: remove comment in resolv.conf
        lineinfile:
          path: result/{{ inventory_hostname }}/resolv.conf
          state: absent
          regexp: '^#'
        delegate_to: localhost

      - name: remove search in resolv.conf
        lineinfile:
          path: result/{{ inventory_hostname }}/resolv.conf
          state: absent
          regexp: '^search'
        delegate_to: localhost

      - name: Append hostname to hosts
        shell: |
          sed -i s/^/{{ inventory_hostname }}\ / result/{{ inventory_hostname }}/hosts
          sed -i s/^/{{ inventory_hostname }}\ / result/{{ inventory_hostname }}/resolv.conf         
        delegate_to: localhost

      - name: Merge multiple hosts files into one single file
        shell: |
          find . -name "hosts" | xargs cat > all-hosts.csv
        args:
          chdir: result/        
        delegate_to: localhost

      - name: insert culumn to all-hosts.csv
        lineinfile:
          path: result/all-hosts.csv
          insertbefore: BOF
          line : Hostname hostsIP hostsNS
        delegate_to: localhost

      - name: Merge multiple resolv files into one single file
        shell: |
          find . -name "resolv.conf" | xargs cat > all-resolv.csv
        args:
          chdir: result/        
        delegate_to: localhost

      - name: insert culumn to all-resolv.csv
        lineinfile:
          path: result/all-resolv.csv
          insertbefore: BOF
          line : Hostname nameserver configNS
        delegate_to: localhost

      - name: insert culumn to resolv.conf
        lineinfile:
          path: result/{{ inventory_hostname }}/resolv.conf
          insertbefore: BOF
          line : Hostname nameserver configNS
        delegate_to: localhost

      - name: insert culumn to hosts file
        lineinfile:
          path: result/{{ inventory_hostname }}/hosts
          insertbefore: BOF
          line : Hostname hostsIP hostsNS
        delegate_to: localhost

      - name: Replace space with comma (,)
        shell: |
          sed -i 's/\ /\,/g' result/{{ inventory_hostname }}/hosts
          sed -i 's/\ /\,/g' result/{{ inventory_hostname }}/resolv.conf   
          sed -i 's/\ /\,/g' result/all-hosts.csv
          sed -i 's/\ /\,/g' result/all-resolv.csv
        delegate_to: localhost          
